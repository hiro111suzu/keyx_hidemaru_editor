# keyx: INIファイルひとつでマクロとキー割り当てを管理
[作者: suzu](https://github.com/hiro111suzu/hidemaru_docs/blob/main/README.md) /
[バージョン: 1][rel] /
[GitHub](https://github.com/hiro111suzu/keyx_hidemaru_editor) /
[公式ライブラリ](https://hide.maruo.co.jp/lib/macro/keyx.html)

[rel]:https://github.com/hiro111suzu/keyx_hidemaru_editor/releases/

# 概要
* 秀丸エディタ・秀丸メールのキー割り当てやマクロ登録の設定画面は、極めて高度で良くデザインされています。とはいえ、同期や大掃除、マニアックなことをしようと思うと、面倒な側面も多々あります。
* 「キー割り当てとマクロ登録をINIファイルで管理できたらいいのにな」と思っているユーザーも多いと思います。
	+ INIファイル一個だけなら見通しが良くなり、忘れてしまった、もう使ってない、なんだかわからないマクロにキーが当たっている状況を避けられる
	+ しっくり来るキー割り当てを探すのに、キー設定とマクロ登録のウインドウを行ったり来たりしなくてもよくなる
	+ OneDriveなどのクラウドストレージでの同期、コメントの付加、コメントアウト、比較、世代管理など、テキストファイル管理のメリットを享受できる
	+ 一時的に入れ替えたり、別マクロから動的に参照・変更することも簡単
* このkeyxは、（完全ではないですが）それを実現するマクロです。
* 拙作の「[秀丸エディタコマンドパレット][コマンドパレット]」と組み合わせると、双方をより有効に使えます。
	+ コマンドパレットなしでも、色々できるようになりました（v1以降）
* 例によって、[秀丸ファイラー版][]もあります。
	+ 同じやり方で、ファイラーも設定管理ができるようになります。

[コマンドパレット]: https://github.com/hiro111suzu/cmdp_hidemaru_editor
[秀丸ファイラー版]: https://github.com/hiro111suzu/keyx_hidemaru_filer

# 仕様と使用法
## インストール
1. 展開したフォルダーを秀丸マクロ用のフォルダーに置く
2. *keyx.mac* をマクロ登録
3. 後述の解説に従って、キー登録や、INI編集などの設定をおこなう

## コマンドパレットと連携（おすすめ）
* 拙作の秀丸マクロ、[秀丸エディタコマンドパレット][]を導入
* INIファイル中のコマンドパレットのマクロファイルのパスを確認
	+ INIファイル *keyx.ini* - セクション *[config]*  - キー *cmdp_path*
	+ フォルダ名が（cmdp）でない場合や、マクロディレクトリ直下でない場合は、書き換えておく
		- コマンドパレットのマクロ *cmdp.mac* のパス、秀丸マクロ用フォルダー以下の部分を記入

```
[config]
cmdp_path = cmdp\cmdp.mac
```

## 仕様
* *keyx.mac* は、以下を実行するだけの非常に単純なマクロです。
	1. 実行時に押されているキーを調べる
	2. それに対応するコマンドをINIファイルから探し出す
	3. それを適当に実行
* *keyx.mac* にたくさんキーを割り当ててしまえば、それらのキーはすべてkeyxのやり方で管理できることになります。
	+ 秀丸エディタは一つのマクロに複数組のキーを割り当てられる
	+ マクロ登録は *keyx.mac* のみでOK
	+ キー登録は使いたいキーの分の作業が必要だが、試行錯誤の不要な単純作業となる
		- 未使用のキーであれば無駄に割り当てても特にデメリットはないので、「具体的な使い道がないが、多めに登録しておく」といった運用も可能
* INIファイル、*keyx.ini* に各キーに割り当てるコマンドを書いていきます。
* コマンドは、多彩な機能を利用できます。
	+ [コマンドパレット][]のコマンドを実行、秀丸マクロ文・マクロファイルを実行、ファイル・URLを開くなど

## INIファイル
### 設定系のセクション
* [config]セクション
	+ *cmdp_path* キーの値にコマンドパレットのパスを記述
	+ *debuginfo* キーの値にでデバッグ情報の出力方式を指定
* [alias_head]
	+ "cmd"とコマンドの「手法」（"cmd"と"open"）を短縮文字を登録できる
	+ コマンドパレットの *_alias_head* と同様の表記をするための機能
* [code2key]
	+ キーコードとキー名の対応
	+ 大文字小文字は区別されない
	+ INIファイル内で対応すればよい、キー名は自分でわかりやすいように書き換えてもOK
* [sample]
	+ マクロからは使われない
	+ キー割り当てのサンプルが書き込んである

### キー・コマンド割当セクション
* キー・コマンド割当セクションでは、ウインドウの種類ごとの設定が可能です。
	+ 通常はセクション *[all]* 内に書き込んでしまえばよいと思う

|セクション名  |意味                                                                   |
|:-------------|:----------------------------------------------------------------------|
|[all]         |ウインドウのタイプを選ばない（下記のセクションが優先）                 |
|[editor]      |秀丸エディタ                                                           |
|[mail_editor] |秀丸メールのメールエディタウインドウ                                   |
|[mail_main]   |秀丸メールのメインウインドウ・検索結果ウインドウ                       |

* 例
```
[editor]
; Ctrlを押しながらHキーを押すと、"menu/help"というコマンドを実行される
Ctrl+h = menu/help
```

* INIキー名は、キーボードのキー（どちらも「キー」でややこしい）
	+ キー名（キーボードの方）は、上述、[code2key]セクションで定義
	+ 修飾キーとの同時押しは ```Shift+Ctrl+Alt+a``` のように表記する
* 「値」は、そのキーに割り当てるコマンド文
	+ コマンド文は最初のスペースまでが「手法」、それ以降は引数となる

|手法   |内容                             |例                              |短縮表記の例                 |
|:------|:--------------------------------|:-------------------------------|:----------------------------|
|*cmd*  |秀丸マクロ文、短縮表記">"        |```cmd message "Hello world"``` |```>message "Hello world"``` |
|*mac*  |マクロファイル実行               |```mac dirname\filename.mac```  |```dirname\filename.mac```   |
|*open* |Windowsシェルで開く、短縮表記"$" |```open c:\hoge\fuga.txt```     |```$c:\hoge\fuga.txt```      |

* それ以外の文字列の場合
	+ マクロファイル名だったら、そのマクロを実行
		- つまり上述「手法」の"mac "は書かなくても同じ
	+ ファイル名、フォルダ名、URLだったら、それを開く
		- つまり上述の「open」も、書かなくても動作すること多い
	+ それ以外の文字列は、[コマンドパレット][]にコマンドとして渡す
* 例
```
	;コマンドパレットに登録したコマンド（独自メニュー）の例
	Ctrl+m = menu/conf

	;マクロファイル実行の例
	Shift+Ctrl+x = directoryname\macrofilename.mac

	;マクロ文実行の例；
	Ctrl+Alt+y = >message "hoge";

	;URLを開く
	Ctlr+F1 = https://google.com
```

## おすすめの使用法
1. まずは、*keyx.mac*をマクロ登録する
2. 使っていないキー（例 Ctrl+b）を、*keyx.mac* に割り当ててみる
3. INIファイルを編集し、そのキー用の機能を記述してみる
```
Ctrl+b = >message "hello world";
```

4. 使用感が掴めたら、割り当てるキーをどんどん増やしていく
	+ 使っていないキーを余分にキー割り当てしても特にデメリットはないはずなので、使い道は後で考えるとして、どんどん登録していけばよいと思われる
5. アウトプット枠への出力が不必要になったら（動作が理解できたら）、INIファイルの '''debuginfo''' を0にすればよい

## 短所と対処法
* これで登録したマクロは、メニューやステータスバーのファンクションキー欄、コマンド一覧機能から呼べない
	+ そういった公式機能経由で起動したいマクロは、普通にマクロ登録するべき
	+ あるいは、後述の「特定のキー用マクロ」を利用すれば、いちおうINI管理との両立は可能
* 一つの動作にいちいち別のマクロを経由するので、無駄なオーバーヘッドになる
	+ 作者は連打系のマクロにも使いまくってて、遅延も問題も感じていない
		- 古めのPCで、数十ミリ秒程度
	+ 気になるなら連打系のマクロは登録しないほうが良いかも
* 秀丸メールでは一つのマクロに複数のキーが割り当てられない
	+ メール本体側は、keyx.macを複数個マクロ登録するしかない
	+ メールエディタウインドウは、秀丸エディタと共通にしておいて、INIの設定で切り分ければ良いと思う
* サポートがない
	+ 見てわかるとおり、極めて単純なマクロ
	+ 今後の仕様変更などへの対応は容易だと思われる

## 特定のキー用マクロ
* ファイル *template.mac* は、以下のように「自身のファイル名を *keyx.mac* に投げるだけ」のマクロ
```
execmacro currentmacrodirectory + "\\keyx.mac", currentmacrobasename;
```
* このファイルをコピーし、中身はそのままでファイル名をキー名にすれば、そのキー用のコマンドを実行するマクロになる
* これで特定のキーに対応するコマンドを単独登録することも可能

# 更新履歴
* [v1][rel]
	+ キーコードとキー名の対応表をINIファイルに移した
	+ コマンドパレットがなくても、色々実行できるようにした
	+ ステータスバーにキー名やコマンドなどの情報を出すようにした
* 無印
	+ 公開

# 使用について
* 使用、複製、改造、再配布に制限はありません。
* 無保証です。

