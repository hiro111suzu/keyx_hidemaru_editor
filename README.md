# keyx: INIファイルひとつでマクロとキー割り当てを管理

作者: suzu

# 概要
* 秀丸エディタ・秀丸メールのキー割り当てやマクロ登録の設定画面は、極めて高度で良くデザインされています。とはいえ、同期や大掃除、マニアックなことをしようと思うと、面倒な側面も多々あります。
* 「キー割り当てとマクロ登録をINIファイルで管理できたらいいのにな」と思っているユーザー多いと思います。
	+ INIファイル一個だけなら見通しが良くなり、忘れてしまった、もう使ってない、なんだかわからないマクロにキーが当たっている状況を避けられる
	+ しっくり来るキー割り当てを探すのに、キー設定とマクロ登録のウインドウを行ったり来たりしなくてもよくなる
	+ OneDriveなどのクラウドストレージでの同期、コメントの付加、コメントアウト、比較、世代管理など、テキストファイル管理のメリットを享受できる
	+ 一時的に入れ替えたり、別マクロから動的に参照・変更することも簡単
* このkeyxは、（完全ではないですが）それを実現するマクロです。
* 拙作の「秀丸エディタコマンドパレット」と組み合わせて使うマクロです。
	+ コマンドパレットを利用してなくても、マクロフォルダーにおいておくだけでOKです。
	+ 利用しているなら、双方をより有効に活用できます。
* 例によって、秀丸ファイラー版も公開予定です。
	+ 同じやり方で、ファイラーも設定管理ができるようになります。

# 仕様と使用法
## インストール
1. 展開したフォルダーを秀丸マクロ用のフォルダーに置く
2. コマンドパレットを利用していないなら、コマンドパレットのフォルダー（*cmdp* フォルダー）も同様に、秀丸マクロ用のフォルダーに置く
	+ コマンドパレットは、ダウンロードパッケージによっては、keyxフォルダー内に同梱されている
3. INIファイル中のコマンドパレットのマクロファイルのパスを確認
	+ INIファイル *keyx.ini* - セクション *[config]*  - キー *cmdp_path* のの値
```
[config]
cmdp_path = cmdp\cmdp.mac
```
	+ コマンドパレットのマクロ *cmdp.mac* のパス、秀丸マクロ用フォルダー以下の部分を記入
	+ フォルダ名が（cmdp）でない場合や、マクロディレクトリ直下でない場合は、書き換えておく

3. *keyx.mac* をマクロ登録
4. 後述の解説に従って、キー登録や、INI編集などの設定をおこなう

## 仕様
* *keyx.mac* は、以下を実行するだけの非常に単純なマクロです。
	1. 実行時に押されているキーを調べる
	2. それに対応するコマンドをINIファイルから探し出す
	3. それを実行マクロに渡す
* *keyx.mac* にたくさんキーを割り当ててしまえば、それらのキーはすべてkeyxのやり方で管理できることになります。
	+ 秀丸エディタは一つのマクロに複数組のキーを割り当てられる
* INIファイル、*keyx.ini* に各キーに割り当てるコマンドを書いていきます。
* 機能の実行系は、「コマンドパレット」に丸投げです。
	+ コマンドパレットの独自メニューなど、すべてのコマンドを利用可能
	+ コマンドパレット側の設定は必要なく、マクロ用フォルダーにおいておくだけでよい
	+ 少しマクロを編集すれば、コマンドパレットを経由せず、マクロファイル実行専門や、マクロ文専門にすることも可能。
		- マクロ中でコメントアウトしてある部分を入れ替えるだけ

## INIファイル
* セクション名（[]の文字列）はウインドウのタイプ
	+ 通常はセクション *[all]* 内に書き込んでしまえばよいと思う

|セクション名  |意味                                                               |
|:-------------|:------------------------------------------------------------------|
|[all]         |ウインドウのタイプを選ばない（下記のセクションが優先）             |
|[editor]      |秀丸エディタ                                                       |
|[mail_editor] |秀丸メールのメールエディタウインドウ                               |
|[mail_main]   |秀丸メールのメインウインドウ・検索結果ウインドウ                   |
|[config]      |キー *cmdp_path* にコマンドパレットのパスを記述                    |
|上記以外      |[sample]など、マクロからは使われないので、コメントとしても利用可能 |

* INIキー名は、キーボードのキー（どちらも「キー」でややこしい）
	+ キー名（キーボードの方）は、マクロ内で定義
	+ 修飾キーとの同時押しは ```shift+ctrl+alt+a``` のようになる
	+ INIファイルと対応さえすればよいので、マクロ内該当部分は自分でわかりやすいように書き換えてもOK
* 「値」はコマンドパレットのコマンド文
	+ コマンドパレットは、デフォルトでマクロ文やマクロファイル名をそのまま実行可能
	+ 「マクロ実行」はマクロファイル名をそのまま書けばよい、フルパスでも、マクロ用ディレクトリ以降だけでもよい
	+ 文字列先頭に">"を書けばマクロ文実行
* 例
```
	;独自メニューの例
	ctrl+m = menu/conf
	;マクロファイル実行の例
	shift+ctrl+x = directoryname\macrofilename.mac
	;マクロ文実行の例；
	ctrl+alt+y = >message "hoge";
```

## おすすめの使用法
1. まずは、*keyx.mac*をマクロ登録する
2. 使っていないキー（例 Ctrl+b）を、*keyx.mac* に割り当ててみる
3. INIファイルを編集し、そのキー用の機能を記述してみる
```
ctrl+b = >message "hello world";
```

4. 使用感が掴めたら、割り当てるキーをどんどん増やしていく
5. アウトプット枠への出力が不必要になったら（動作が理解できたら）、マクロ一行目の '''debuginfo 2;''' をコメントアウトすればよい

## 短所と対処法
* これで登録したマクロは、メニューやステータスバーのファンクションキー欄、コマンド一覧機能から呼べない
	+ そういった公式機能経由で起動したいマクロは、普通にマクロ登録するべき
	+ あるいは、後述の「特定のキー用マクロ」を利用すれば、いちおうINI管理との両立は可能
* 一つの動作にいちいち別のマクロを経由するので、無駄なオーバーヘッドになる
	+ 作者は連打系のマクロにも使いまくってて、遅延も問題も感じていない
		- 古めのPCで、数十マイクロ秒程度
	+ 気になるなら連打系のマクロは登録しないほうが良いかも
* 秀丸メールでは一つのマクロに複数のキーが割り当てられない
	+ メール本体側は、keyx.macを複数個マクロ登録するしかない
	+ メールエディタウインドウは、秀丸エディタと共通にしておいて、INIの設定で切り分ければ良いと思う
* サポートがない
	+ 見てわかるとおり、極めて単純なマクロ
	+ 今後の仕様変更などへの対応は容易だと思われる

## 特定のキー用マクロ
* ファイル *template.mac* は、以下のように「自身のファイル名を *keyx.mac* に投げるだけ」のマクロ
```
execmacro currentmacrodirectory + "\\keyx.mac", currentmacrobasename;
```
* このファイルをコピーし、中身はそのままでファイル名をキー名にすれば、そのキー用のコマンドを実行するマクロになる
* これで特定のキーに対応するコマンドを単独登録することも可能

# 使用について
* 使用、複製、改造、再配布に制限はありません。
* 無保証です。

